from __future__ import annotations

import concurrent.futures as fut
import logging
import random
import shutil
import uuid
from pathlib import Path
from typing import Iterable

from ai_scientist import llm
from ai_scientist.treesearch.backend import query, FunctionSpec
from ai_scientist.perform_icbinb_writeup import perform_writeup
from .core import (
    PaperNode,
    Journal,
    safe_evaluate,
    _crossover_papers,
    unique_subdir,
    EDITOR_MODEL,
    VLM_MODEL,
    DEFAULT_MODEL,
    ORCHESTRATOR_MODEL,
)

logger = logging.getLogger(__name__)

# ---------------------------------------------------------------------------
# —— GENETIC UTILITY FUNCTIONS ———————————————————————————————————————————
# ---------------------------------------------------------------------------

_SELECTION_SPEC = FunctionSpec(
    name="select_elites",
    description="Return a JSON list of IDs of the best papers",
    json_schema={
        "type": "object",
        "properties": {"elite_ids": {"type": "array", "items": {"type": "string"}}},
        "required": ["elite_ids"],
    },
)


def orchestrator_select_elites(
    population: list[PaperNode], k: int, model: str = ORCHESTRATOR_MODEL
) -> list[PaperNode]:
    """Ask the orchestrator model to pick *k* elites from the population."""
    if k <= 0:
        return []

    prompt = {
        "Role": (
            "You are a senior area‑chair.  Select the **best** papers "
            f"(up to {k}) based on the given reviews and scores."
        ),
        "Candidates": "",
    }
    for n in population:
        prompt["Candidates"] += (
            f"ID: {n.id}\n"
            f"Score: {n.score:.3f}\n"
            f"Paper (trimmed):\n{n.tex_path.read_text()[:1_000]}\n"
            f"Reviews: {str(n.llm_jsons)[:1_000]} {str(n.vlm_json)[:500]}\n\n"
        )

    try:
        out = query(
            system_message=prompt,
            user_message=None,
            func_spec=_SELECTION_SPEC,
            model=model,
            temperature=0.2,
        )
        chosen = {cid for cid in out["elite_ids"][:k]}
        return [n for n in population if n.id in chosen][:k]
    except Exception as exc:
        logger.warning("Orchestrator elite selection failed: %s – using top‑k by score", exc)
        return sorted(population, key=lambda n: n.score or -1, reverse=True)[:k]


def tournament_pick(pop: list[PaperNode], tour_size: int) -> PaperNode:
    """Return *one* parent chosen via size‑`tour_size` tournament selection."""
    contenders = random.sample(pop, tour_size)
    return max(contenders, key=lambda n: n.score or 0.0)


def build_child(
    parent_a: PaperNode,
    parent_b: PaperNode,
    *,
    editor_model: str,
    review_model: str,
    vlm_model: str,
    perform_kwargs: dict,
    llm_review_kwargs: dict,
    vlm_review_kwargs: dict,
    journal: Journal,
) -> PaperNode:
    """Create, write‑up and evaluate a new child node."""
    # ------------------------------------------------------------------ merge
    merged_tex = _crossover_papers(parent_a, (parent_b,), model=editor_model)

    # ------------------------------------------------ create scratch folder
    scratch_dir = unique_subdir(parent_a.latex_dir.parent.parent, "child_" + uuid.uuid4().hex[:6])
    latex_dir  = scratch_dir / "latex"
    latex_dir.mkdir(parents=True)
    (latex_dir / "template.tex").write_text(merged_tex, encoding="utf‑8")

    # ------------------------------------------------ run write‑up to flesh out paper
    perform_writeup(base_folder=scratch_dir, **perform_kwargs)

    # ------------------------------------------------ wrap as node & evaluate
    child = PaperNode(
        latex_dir,
        depth=max(parent_a.depth, parent_b.depth) + 1,
        parent=None,
        llm_model=review_model,
        vlm_model=vlm_model,
    )
    safe_evaluate(child, llm_kwargs=llm_review_kwargs, vlm_kwargs=vlm_review_kwargs)
    journal.append(child)
    return child


def _evaluate_many(
    nodes: Iterable[PaperNode],
    executor: fut.Executor | None,
    llm_kwargs: dict,
    vlm_kwargs: dict,
) -> None:
    """Evaluate nodes serially or in parallel."""
    if executor is None:
        for n in nodes:
            safe_evaluate(n, llm_kwargs=llm_kwargs, vlm_kwargs=vlm_kwargs)
    else:
        futures = {
            executor.submit(safe_evaluate, n, llm_kwargs=llm_kwargs, vlm_kwargs=vlm_kwargs): n
            for n in nodes
        }
        for f in fut.as_completed(futures):
            _ = f.result()  # propagate exceptions early
# ---------------------------------------------------------------------------

# ---------------------------------------------------------------------------
# —— MAIN EVOLUTION ROUTINE ———————————————————————————————————————————————
# ---------------------------------------------------------------------------


def genetic_search_improve(
    root_dir: Path,
    *,
    population_size: int = 12,
    generations: int = 25,
    elite_size: int = 2,
    tournament_size: int = 3,
    editor_model: str = EDITOR_MODEL,
    review_model: str = DEFAULT_MODEL,
    vlm_model: str = VLM_MODEL,
    orchestrator_model: str = ORCHESTRATOR_MODEL,
    perform_kwargs: dict | None = None,
    llm_review_kwargs: dict | None = None,
    vlm_review_kwargs: dict | None = None,
    parallel_workers: int | None = None,
) -> tuple[PaperNode | None, Journal]:
    """
    A steady‑state GA for LaTeX‑paper optimisation.

    • *population_size* : constant |P|.
    • *elite_size*      : number of copies that survive each generation.
    • *tournament_size* : ≥ 2 for parent selection.
    • *generations*     : stop after this many full replacements.
    """
    # ---------------- default kwargs ---------------------------------------------------
    perform_kwargs     = perform_kwargs or {}
    llm_review_kwargs  = llm_review_kwargs or {}
    vlm_review_kwargs  = vlm_review_kwargs or {}

    # ---------------- bookkeeping ------------------------------------------------------
    journal   = Journal()
    rng       = random.Random()
    executor  = fut.ThreadPoolExecutor(max_workers=parallel_workers) if parallel_workers else None

    # ---------------- seed population --------------------------------------------------
    root_node = PaperNode(root_dir, llm_model=review_model, vlm_model=vlm_model)
    safe_evaluate(root_node, llm_kwargs=llm_review_kwargs, vlm_kwargs=vlm_review_kwargs)
    journal.append(root_node)

    population: list[PaperNode] = [root_node]

    while len(population) < population_size:
        # Simple bootstrapping: mutate root against itself until we reach |P|
        child = build_child(
            parent_a=root_node,
            parent_b=root_node,
            editor_model=editor_model,
            review_model=review_model,
            vlm_model=vlm_model,
            perform_kwargs=perform_kwargs,
            llm_review_kwargs=llm_review_kwargs,
            vlm_review_kwargs=vlm_review_kwargs,
            journal=journal,
        )
        population.append(child)

    # ---------------- evolutionary loop -----------------------------------------------
    for gen in range(generations):
        logger.info("— Generation %d —", gen + 1)

        # 1. Pick elites
        elites = orchestrator_select_elites(population, elite_size, model=orchestrator_model)
        logger.debug("Elites: %s", [e.id for e in elites])

        # 2. Create children to fill the remainder of the population
        children: list[PaperNode] = []
        while len(children) < (population_size - elite_size):
            p1 = tournament_pick(population, tournament_size)
            p2 = tournament_pick(population, tournament_size)
            if p1 is p2:  # enforce two distinct parents
                continue
            child = build_child(
                parent_a=p1,
                parent_b=p2,
                editor_model=editor_model,
                review_model=review_model,
                vlm_model=vlm_model,
                perform_kwargs=perform_kwargs,
                llm_review_kwargs=llm_review_kwargs,
                vlm_review_kwargs=vlm_review_kwargs,
                journal=journal,
            )
            children.append(child)

        # 3. Evaluate (already done inside build_child, but if you build differently
        #    you could defer & call _evaluate_many here)

        # 4. Form next generation
        population = elites + children
        assert len(population) == population_size

        # 5. Optional: early‑stop if no improvement for N generations, etc.
        #    (left to the caller if desired)

    if executor:
        executor.shutdown(wait=True)

    # ---------------- return best found ------------------------------------------------
    best = max(journal.good_nodes, key=lambda n: n.score or -1, default=None)
    return best, journal
